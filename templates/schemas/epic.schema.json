{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "title": "Epic Schema",
  "description": "Comprehensive schema for Product Epics supporting both PRD-linked (Mode 1) and RFC-only (Mode 2) enhancement workflows",
  "type": "object",
  "required": ["epic_id", "title", "description", "priority", "status", "business_context", "scope", "team", "timestamps"],
  "oneOf": [
    {
      "required": ["prd_reference"],
      "not": {
        "required": ["rfc_reference", "enhancement_context"]
      }
    },
    {
      "required": ["rfc_reference", "enhancement_context"],
      "not": {
        "required": ["prd_reference"]
      }
    }
  ],
  "properties": {
    "epic_id": {
      "type": "string",
      "pattern": "^epic-[a-z0-9-]+$",
      "description": "Unique epic identifier (e.g., epic-001, epic-user-auth, epic-RFC-RFC-001-1 for RFC-only enhancements)"
    },
    "prd_reference": {
      "type": "object",
      "description": "Reference to parent PRD (Mode 1: PRD-linked epics). Mutually exclusive with rfc_reference.",
      "required": ["prd_id", "requirements_addressed"],
      "properties": {
        "prd_id": {
          "type": "string",
          "pattern": "^prd-[a-z0-9-]+$",
          "description": "Reference to the parent PRD document"
        },
        "requirements_addressed": {
          "type": "array",
          "description": "PRD requirements (REQ-###) that this epic addresses",
          "items": {
            "type": "string",
            "pattern": "^REQ-\\d+$"
          },
          "minItems": 1
        }
      }
    },
    "rfc_reference": {
      "type": "object",
      "description": "Reference to parent RFC (Mode 2: RFC-only enhancement epics). Mutually exclusive with prd_reference.",
      "required": ["rfc_id"],
      "properties": {
        "rfc_id": {
          "type": "string",
          "pattern": "^RFC-\\d+$",
          "description": "Reference to the parent RFC document"
        },
        "sections": {
          "type": "array",
          "description": "RFC sections (e.g., '4.2', '5.1') that this epic implements",
          "items": {
            "type": "string",
            "pattern": "^\\d+(\\.\\d+)*$"
          }
        },
        "architecture_components": {
          "type": "array",
          "description": "Architecture components from RFC that this epic covers",
          "items": {
            "type": "string"
          }
        },
        "implementation_phase": {
          "type": "string",
          "description": "RFC implementation phase (e.g., 'Phase 1: Foundation', 'Phase 2: Core Features')"
        },
        "enhancement_type": {
          "type": "string",
          "enum": ["feature_enhancement", "refactoring", "optimization", "bugfix", "technical_debt"],
          "description": "Type of enhancement from RFC"
        },
        "scope": {
          "type": "string",
          "enum": ["partial", "complete", "comprehensive"],
          "description": "Scope of the RFC enhancement (partial=subset, complete=feature/subsystem, comprehensive=cross-cutting)"
        },
        "backward_compatible": {
          "type": "boolean",
          "description": "Whether this enhancement maintains backward compatibility"
        }
      }
    },
    "enhancement_context": {
      "type": "object",
      "description": "Enhancement context details (Mode 2 only: RFC-only enhancements without PRD)",
      "required": ["type", "reason"],
      "properties": {
        "type": {
          "type": "string",
          "enum": ["feature_enhancement", "refactoring", "optimization", "bugfix", "technical_debt"],
          "description": "Type of enhancement"
        },
        "reason": {
          "type": "string",
          "minLength": 30,
          "description": "Business or technical justification for this enhancement (minimum 30 words)"
        },
        "current_state": {
          "type": "string",
          "description": "Description of what currently exists and what will be improved"
        },
        "desired_state": {
          "type": "string",
          "description": "Description of the desired state after enhancement"
        },
        "scope": {
          "type": "string",
          "enum": ["partial", "complete", "comprehensive"],
          "description": "Scope of enhancement impact"
        },
        "impact_analysis": {
          "type": "string",
          "description": "What existing functionality is impacted or changed"
        },
        "backward_compatibility": {
          "type": "string",
          "description": "Backward compatibility assessment (yes/no/partial with migration path)"
        },
        "migration_path": {
          "type": "string",
          "description": "Path for users/systems to migrate if breaking changes introduced"
        }
      }
    },
    "title": {
      "type": "string",
      "description": "Feature-focused epic title (e.g., 'User Authentication System')",
      "minLength": 10,
      "maxLength": 150
    },
    "description": {
      "type": "string",
      "description": "User value-focused description of the epic",
      "minLength": 50,
      "maxLength": 500
    },
    "priority": {
      "type": "string",
      "enum": ["critical", "high", "medium", "low"],
      "description": "Business priority level for this epic"
    },
    "status": {
      "type": "string",
      "enum": ["planning", "in_progress", "blocked", "completed", "deprecated"],
      "description": "Current status of the epic"
    },
    "labels": {
      "type": "array",
      "description": "Tags/labels inherited from PRD plus epic-specific labels",
      "items": {
        "type": "string"
      }
    },
    "business_context": {
      "type": "object",
      "description": "Business value and impact information",
      "required": ["business_value", "user_impact"],
      "properties": {
        "business_value": {
          "type": "string",
          "description": "Why this epic matters to the business",
          "minLength": 30
        },
        "success_metrics": {
          "type": "array",
          "description": "Measurable indicators for epic success",
          "items": {
            "type": "string"
          }
        },
        "user_impact": {
          "type": "string",
          "description": "How users benefit from this epic",
          "minLength": 30
        },
        "business_goals": {
          "type": "array",
          "description": "Business goals this epic addresses",
          "items": {
            "type": "string"
          }
        }
      }
    },
    "scope": {
      "type": "object",
      "description": "Epic scope definition and relationships",
      "required": ["features_included"],
      "properties": {
        "related_prd_sections": {
          "type": "array",
          "description": "Section numbers from parent PRD (e.g., '6.1', '6.2') - used for Mode 1 PRD-linked epics",
          "items": {
            "type": "string",
            "pattern": "^\\d+(\\.\\d+)*$"
          }
        },
        "related_rfc_sections": {
          "type": "array",
          "description": "RFC section references (e.g., '4.2', '5.1') - used for Mode 2 RFC-only epics",
          "items": {
            "type": "string",
            "pattern": "^\\d+(\\.\\d+)*$"
          }
        },
        "features_included": {
          "type": "array",
          "description": "List of features included in this epic",
          "items": {
            "type": "string"
          },
          "minItems": 1
        },
        "keywords": {
          "type": "array",
          "description": "Keywords for searchability and categorization",
          "items": {
            "type": "string"
          }
        },
        "dependencies": {
          "type": "array",
          "description": "Other epics or requirements this epic depends on",
          "items": {
            "type": "string"
          }
        },
        "constraints": {
          "type": "array",
          "description": "Technical or business constraints for this epic",
          "items": {
            "type": "string"
          }
        }
      }
    },
    "team": {
      "type": "object",
      "description": "Team ownership and stakeholder information",
      "required": ["owner"],
      "properties": {
        "owner": {
          "type": "string",
          "description": "Epic owner (person or team responsible)",
          "minLength": 1
        },
        "stakeholders": {
          "type": "array",
          "description": "Key stakeholders inherited from PRD plus epic-specific stakeholders",
          "items": {
            "type": "string"
          }
        },
        "assigned_team": {
          "type": ["string", "null"],
          "description": "Team assigned to deliver this epic"
        },
        "reviewers": {
          "type": "array",
          "description": "People responsible for reviewing epic completion",
          "items": {
            "type": "string"
          }
        }
      }
    },
    "timeline": {
      "type": "object",
      "description": "Timeline information for the epic",
      "properties": {
        "start_date": {
          "type": ["string", "null"],
          "format": "date",
          "description": "Start date (YYYY-MM-DD)"
        },
        "target_date": {
          "type": ["string", "null"],
          "format": "date",
          "description": "Target completion date (YYYY-MM-DD)"
        },
        "actual_completion_date": {
          "type": ["string", "null"],
          "format": "date",
          "description": "Actual completion date (YYYY-MM-DD)"
        }
      }
    },
    "progress": {
      "type": "object",
      "description": "Progress tracking and effort metrics",
      "properties": {
        "total_tasks": {
          "type": "integer",
          "description": "Total number of tasks in this epic",
          "minimum": 0
        },
        "completed_tasks": {
          "type": "integer",
          "description": "Number of completed tasks",
          "minimum": 0
        },
        "in_progress_tasks": {
          "type": "integer",
          "description": "Number of tasks currently in progress",
          "minimum": 0
        },
        "blocked_tasks": {
          "type": "integer",
          "description": "Number of blocked tasks",
          "minimum": 0
        },
        "total_estimated_effort": {
          "type": "number",
          "description": "Total estimated effort in story points or hours",
          "minimum": 0
        },
        "actual_effort": {
          "type": "number",
          "description": "Actual effort spent in story points or hours",
          "minimum": 0
        },
        "progress_percentage": {
          "type": "number",
          "description": "Percentage of epic completion (0-100)",
          "minimum": 0,
          "maximum": 100
        }
      }
    },
    "timestamps": {
      "type": "object",
      "description": "Lifecycle timestamps for the epic",
      "required": ["created_at", "updated_at"],
      "properties": {
        "created_at": {
          "type": "string",
          "format": "date-time",
          "description": "ISO 8601 timestamp when epic was created"
        },
        "updated_at": {
          "type": "string",
          "format": "date-time",
          "description": "ISO 8601 timestamp of last update"
        },
        "deprecated_at": {
          "type": ["string", "null"],
          "format": "date-time",
          "description": "ISO 8601 timestamp when epic was deprecated (if applicable)"
        },
        "deprecated_reason": {
          "type": ["string", "null"],
          "description": "Reason for deprecation, if applicable"
        }
      }
    }
  }
}